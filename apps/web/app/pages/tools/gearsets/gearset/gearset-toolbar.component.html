@if (!isLoaded() || (isLoading() && !gearset())) {

} @else if (!isOwned()) {
  <div class="p-3 mx-auto">
    <div class="alert bg-base-100 shadow-lg max-w-md">
      <nwb-icon [icon]="iconGlobe" class="w-5 h-5 text-success" />
      <div class="flex-1">
        <h3 class="font-bold">Public gearset</h3>
        <p class="text-xs">You can import this item into your collection.</p>
      </div>
      <div class="flex-none">
        <button class="btn btn-sm btn-primary" (click)="onImportClicked()">Import</button>
      </div>
    </div>
  </div>
} @else {
  <button class="btn btn-square btn-ghost" [class.text-error]="mode === 'opponent'" (click)="handleBackClicked()">
    @if (mode === 'opponent') {
      <nwb-icon [icon]="iconClose" class="w-4 h-4" />
    } @else {
      <nwb-icon [icon]="iconBack" class="w-4 h-4" />
    }
  </button>

  <label class="input input-bordered w-full h-8 my-1 flex items-center gap-1">
    <input
      type="text"
      class="grow"
      maxlength="100"
      [ngModel]="gearset()?.name"
      (ngModelChange)="updateName($event)"
      [ngModelOptions]="{ updateOn: 'blur' }"
      [disabled]="!isEditable()"
    />
    @if (isEditable()) {
      @if (isSyncPending()) {
        <nwb-icon
          [icon]="iconInfo"
          class="w-4 h-4 text-warning cursor-help tooltip tooltip-left"
          [attr.data-tip]="'Sync pending'"
        />
      }
      @if (isSyncConflict()) {
        <nwb-icon
          [icon]="iconInfo"
          class="w-4 h-4 text-error cursor-help tooltip tooltip-left"
          [attr.data-tip]="'Sync conflict'"
        />
      }
      @if (isPublic()) {
        <nwb-icon
          [icon]="iconGlobe"
          class="w-4 h-4 text-success cursor-help tooltip tooltip-left"
          [attr.data-tip]="'Public gearset'"
        />
      }
    }
  </label>

  <div class="join">
    @if (isEditable()) {
      <button class="join-item btn btn-ghost btn-square" [cdkMenuTriggerFor]="tplTagPicker" [tooltip]="'Edit Tags'">
        <nwb-icon [icon]="iconTags" class="w-4 h-4" />
      </button>
      <ng-template #tplTagPicker>
        <div class="p-2 bg-base-200 border border-base-100 rounded-md shadow-lg" cdkMenu>
          <nwb-chips-input-pane
            [tags]="presetTags"
            [placeholder]="'custom tags'"
            [ngModel]="gearset()?.tags"
            (ngModelChange)="updateTags(gearset(), $event)"
          />
        </div>
      </ng-template>
    }

    @if (!isEditable()) {
      <button
        class="join-item btn btn-ghost btn-square"
        (click)="onImportClicked()"
        [tooltip]="'Import to own collection'"
      >
        <nwb-icon [icon]="iconImport" class="w-4 h-4" />
      </button>
    }

    <button
      [nwbScreenshotBtn]
      class="join-item btn btn-ghost btn-square"
      [tooltip]="'Screenshot'"
      [disabled]="!gearset()"
    ></button>

    @if (isEditable()) {
      <button class="join-item btn btn-ghost btn-square" [cdkMenuTriggerFor]="menu">
        <nwb-icon [icon]="iconMenu" class="w-4 h-4" />
      </button>
    }
  </div>
}

<ng-template #menu>
  <ul class="my-1 menu menu-compact bg-base-200 border border-base-100 rounded-md shadow-lg p-0" cdkMenu>
    @if (!isSignedIn()) {
      <li class="text-shadow-sm shadow-black">
        <a cdkMenuItem (click)="onShareClicked()" class="rounded-none">
          <nwb-icon [icon]="iconShare" class="w-4 h-4 mr-2" />
          <div class="flex flex-col leading-none">
            <span>Share</span>
            <span class="text-xs opacity-75">Upload online and create a share URL</span>
          </div>
        </a>
      </li>
    } @else if (isPublic()) {
      <li class="text-shadow-sm shadow-black">
        <button cdkMenuItem (click)="onUnpublishClicked()" class="rounded-none">
          <nwb-icon [icon]="iconShare" class="w-4 h-4 mr-2" />
          <div class="flex flex-col leading-none">
            <span>Unpublish</span>
            <span class="text-xs opacity-75">Removes this gearset from public listing</span>
          </div>
        </button>
      </li>
    } @else {
      <li class="text-shadow-sm shadow-black">
        <button cdkMenuItem (click)="onPublishClicked()" class="rounded-none" [disabled]="!isPublishable()">
          <nwb-icon [icon]="iconShare" class="w-4 h-4 mr-2" />
          <div class="flex flex-col leading-none">
            <span>Publish</span>
            @if (isPublishable()) {
              <span class="text-xs opacity-75">Publish this gearsets for other users to see</span>
            } @else {
              <span class="text-xs text-error">Gearsets with <b>linked</b> items can not be published</span>
            }
          </div>
        </button>
      </li>
    }

    <li class="text-shadow-sm shadow-black">
      <a (click)="onCloneClicked()" cdkMenuItem class="rounded-none">
        <nwb-icon [icon]="iconCopy" class="w-4 h-4 mr-2" />
        <div class="flex flex-col leading-none">
          <span>Copy</span>
          <span class="text-xs opacity-75">Create a copy of this set</span>
        </div>
      </a>
    </li>

    <li class="menu-title">
      <span>Batch Edit</span>
    </li>
    <li class="text-shadow-sm shadow-black">
      <a (click)="onBatchGearScoreClicked()" cdkMenuItem class="rounded-none">
        <img [nwImage]="'assets/icons/item/icon_gearscore.png'" class="w-4 h-4 mr-2" />
        <div class="flex flex-col leading-none">
          <span>Gear Score</span>
          <span class="text-xs opacity-75">Change gear score for multiple items</span>
        </div>
      </a>
    </li>
    <li class="text-shadow-sm shadow-black">
      <a (click)="onBatchGemClicked()" cdkMenuItem class="rounded-none">
        <img [nwImage]="'assets/icons/menu/gems.png'" class="w-4 h-4 mr-2" />
        <div class="flex flex-col leading-none">
          <span>Gems</span>
          <span class="text-xs opacity-75">Pick a gem and apply to multiple items</span>
        </div>
      </a>
    </li>
    <li class="text-shadow-sm shadow-black">
      <a (click)="onBatchAttributeClicked()" cdkMenuItem class="rounded-none">
        <img [nwImage]="'assets/icons/icon_attribute_arrow.png'" class="w-4 h-4 mr-2" />
        <div class="flex flex-col leading-none">
          <span>Attributes</span>
          <span class="text-xs opacity-75">Pick an attribute and apply to multiple items</span>
        </div>
      </a>
    </li>

    <li class="text-shadow-sm shadow-black">
      <a (click)="onBatchResetClicked()" cdkMenuItem class="rounded-none">
        <nwb-icon [icon]="iconReset" class="w-4 h-4 mr-2" />
        <div class="flex flex-col leading-none">
          <span>Reset Perks</span>
          <span class="text-xs opacity-75">Reset perks on multiple items</span>
        </div>
      </a>
    </li>

    <li class="menu-title">
      <span>Damage Calculator</span>
    </li>
    <li class="text-shadow-sm shadow-black">
      <a (click)="handleOpponentSelection()" cdkMenuItem class="rounded-none">
        <nwb-icon [icon]="iconSwords" class="w-4 h-4 mr-2" />
        <div class="flex flex-col leading-none">
          <span>Pick Opponent Set</span>
          <span class="text-xs opacity-75">Pick another gearset for PvP calculation</span>
        </div>
      </a>
    </li>

    <li class="text-shadow-sm shadow-black">
      <a (click)="onToggleCalculatorClicked()" cdkMenuItem class="rounded-none">
        <nwb-icon [icon]="iconCalculator" class="w-4 h-4 mr-2" />
        <div class="flex flex-col leading-none">
          <span>Toggle calculator</span>
          <span class="text-xs opacity-75">Toggle damage calculator sidebar</span>
        </div>
      </a>
    </li>

    <li class="divider my-1 h-[2px]"></li>
    <li class="text-shadow-sm shadow-black">
      <a (click)="onToggleItemInfoClicked()" cdkMenuItem class="rounded-none">
        <nwb-icon [icon]="iconInfo" class="w-4 h-4 mr-2" />
        <div class="flex flex-col leading-none">
          <span>Toggle item info</span>
          <span class="text-xs opacity-75">Toggle item description and infos</span>
        </div>
      </a>
    </li>
    <li class="text-shadow-sm shadow-black">
      <a (click)="onDeleteClicked()" cdkMenuItem class="rounded-none">
        <nwb-icon [icon]="iconDelete" class="w-4 h-4 text-error mr-2" />
        <div class="flex flex-col leading-none">
          <span>Delete</span>
          <span class="text-xs opacity-75">Delete this set</span>
        </div>
      </a>
    </li>
  </ul>
</ng-template>
